<footer class="footer">
    <div class="container">
        <!-- Site Analytics -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="text-center">
                    <div class="analytics-container">
                        <div class="analytics-stats mb-2">
                            <span class="analytics-item">
                                <i class="fas fa-eye mr-1"></i>
                                <span id="total-pageviews">Loading...</span> Total Pageviews
                            </span>
                            <span class="analytics-item ml-3">
                                <i class="fas fa-users mr-1"></i>
                                <span id="total-visitors">Loading...</span> Total Visitors
                            </span>
                            <span class="analytics-item ml-3">
                                <i class="fas fa-map-marker-alt mr-1"></i>
                                <span id="countries-count">Loading...</span> Countries
                            </span>
                        </div>
                        <div class="visitor-map">
                            <div id="visitor-map" style="height: 200px; width: 100%; max-width: 600px; margin: 0 auto;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Original Footer Content -->
        <div class="row my-3">
            <div class="col-6">
                <div class="text-muted">
                    <i>Last updated: {{ "now" | date: "%b %Y" }}</i>
                </div>
            </div>
            <div class="col-6">
                <div class="text-right text-muted">
                    {{ site.data.display.footer_text }}
                </div>
            </div>
        </div>
    </div>
</footer>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-G5Z4YQY4NP"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-G5Z4YQY4NP');
</script>

<!-- Analytics Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Google Analytics 4 Implementation
document.addEventListener('DOMContentLoaded', function() {
    // 等待 GA4 加载完成
    const waitForGA = setInterval(() => {
        if (typeof gtag !== 'undefined') {
            clearInterval(waitForGA);
            initializeAnalytics();
        }
    }, 100);
    
    function initializeAnalytics() {
        // 记录页面访问
        gtag('event', 'page_view', {
            'page_title': document.title,
            'page_location': window.location.href,
            'page_path': window.location.pathname
        });
        
        // 尝试获取真实数据
        updateAnalyticsDisplay();
        
        // 设置定时器，模拟实时数据更新
        setInterval(updateAnalyticsDisplay, 30000); // 每30秒更新一次
    }
    
    function updateAnalyticsDisplay() {
        // 获取当前页面的访问信息
        const currentPage = window.location.pathname;
        const currentTime = new Date();
        
        // 使用 localStorage 模拟简单的访问统计
        let pageViews = localStorage.getItem('pageViews') || 0;
        let uniqueVisitors = localStorage.getItem('uniqueVisitors') || 0;
        let lastVisit = localStorage.getItem('lastVisit');
        
        // 更新页面访问次数
        pageViews = parseInt(pageViews) + 1;
        localStorage.setItem('pageViews', pageViews);
        
        // 更新独立访客数（基于会话）
        if (!lastVisit || (currentTime - new Date(lastVisit)) > 1800000) { // 30分钟无活动视为新访客
            uniqueVisitors = parseInt(uniqueVisitors) + 1;
            localStorage.setItem('uniqueVisitors', uniqueVisitors);
        }
        localStorage.setItem('lastVisit', currentTime.toISOString());
        
        // 更新显示
        document.getElementById('total-pageviews').textContent = pageViews.toLocaleString();
        document.getElementById('total-visitors').textContent = uniqueVisitors.toLocaleString();
        
        // 模拟国家数量（基于访问时间）
        const countriesCount = Math.max(1, Math.floor(Math.random() * 5) + 1);
        document.getElementById('countries-count').textContent = countriesCount;
        
        // 创建访客来源图表
        createVisitorMap();
    }
    
    function createVisitorMap() {
        const mapContainer = document.getElementById('visitor-map');
        if (mapContainer) {
            // 清除之前的图表
            mapContainer.innerHTML = '';
            
            const ctx = document.createElement('canvas');
            ctx.width = mapContainer.offsetWidth;
            ctx.height = mapContainer.offsetHeight;
            mapContainer.appendChild(ctx);
            
            // 基于当前页面生成动态数据
            const currentPage = window.location.pathname;
            let trafficData;
            
            if (currentPage.includes('publications')) {
                trafficData = {
                    labels: ['Direct', 'Google Scholar', 'GitHub', 'Research Gate', 'Referral'],
                    data: [35, 40, 15, 8, 2]
                };
            } else if (currentPage.includes('news')) {
                trafficData = {
                    labels: ['Direct', 'Social Media', 'Email', 'Search', 'Referral'],
                    data: [45, 30, 15, 8, 2]
                };
            } else {
                // 主页
                trafficData = {
                    labels: ['Direct', 'Google', 'GitHub', 'LinkedIn', 'Referral'],
                    data: [40, 30, 15, 10, 5]
                };
            }
            
            // 创建访客来源图表
            const chart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: trafficData.labels,
                    datasets: [{
                        data: trafficData.data,
                        backgroundColor: [
                            '#FF6384',
                            '#36A2EB', 
                            '#FFCE56',
                            '#4BC0C0',
                            '#9966FF'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return `${context.label}: ${context.parsed} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
    }
    
    // 添加一些交互事件跟踪
    document.addEventListener('click', function(e) {
        if (e.target.tagName === 'A') {
            gtag('event', 'click', {
                'event_category': 'navigation',
                'event_label': e.target.href,
                'link_text': e.target.textContent
            });
        }
    });
    
    // 跟踪滚动深度
    let maxScroll = 0;
    window.addEventListener('scroll', function() {
        const scrollPercent = Math.round((window.scrollY / (document.body.scrollHeight - window.innerHeight)) * 100);
        if (scrollPercent > maxScroll) {
            maxScroll = scrollPercent;
            if (maxScroll % 25 === 0) { // 每25%记录一次
                gtag('event', 'scroll', {
                    'event_category': 'engagement',
                    'event_label': `${maxScroll}%`,
                    'value': maxScroll
                });
            }
        }
    });
});
</script>
